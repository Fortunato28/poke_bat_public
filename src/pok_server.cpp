// This autogenerated skeleton file illustrates how to build a server.
// You should copy it to another filename to avoid overwriting it.

#include <thrift/protocol/TBinaryProtocol.h>
#include <thrift/server/TSimpleServer.h>
#include <thrift/transport/TServerSocket.h>
#include <thrift/transport/TBufferTransports.h>

#include "pok_server.h"
#include "gen-cpp/PokServer.h"
#include "fight.h"
#include "server_config_handler.h"
#include "conf.h"

using namespace ::apache::thrift;
using namespace ::apache::thrift::protocol;
using namespace ::apache::thrift::transport;
using namespace ::apache::thrift::server;

using namespace ::poke_bat::middleware;
using namespace work_with_datbase;

PokServerHandler::PokServerHandler() 
    : next_fight_id_(0),
      dbManager_(host, user, pass, db)
{
}

Fight PokServerHandler::findFight(const int64_t &fight_id)
{
    //printf("%lu", fight_storage.find(fight_id)->first);
    return fight_storage_.at(fight_id);
}

void PokServerHandler::getConfig(std::string& _return)
{
    serverConfigHandler configHandler;
    _return = configHandler.EncryptConfig();
}

void PokServerHandler::startFight(FightData& _return, const int64_t complexity, const Pokemon& clientPokemon)
{
  _return.pokemon = dbManager_.GetPokemon(complexity);
  Fight fight(clientPokemon, _return.pokemon);
  fight_storage_.emplace(next_fight_id_, fight);

  //printf("%s\n", clientPokemon.name.c_str());

  _return.__set_fight_id(next_fight_id_);
  ++next_fight_id_;
}

void PokServerHandler::punch(RoundResult& _return, const int64_t fight_id)
{
  // Your implementation goes here
    Fight current_fight = findFight(fight_id);
    auto& c_pok = current_fight.client_pokemon_;
    auto& s_pok = current_fight.server_pokemon_;

    printf("punch\n");
}

void PokServerHandler::defend(RoundResult& _return, const int64_t fight_id)
{
  // Your implementation goes here
  findFight(fight_id);
  printf("defend\n");
}

void PokServerHandler::useSkill(RoundResult& _return, const int64_t fight_id, const std::string& skillName)
{
  // Your implementation goes here
  findFight(fight_id);
  printf("useSkill\n");
}
